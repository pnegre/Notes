{% extends "notes/base.html" %}

{% block head %}

<script type="text/javascript">

$(document).ready(function() {

		var csrftoken = getCookie('csrftoken');

		$.ajaxSetup({
		error:function(x,e){
				if(x.status==0){
				alert('You are offline!!\n Please Check Your Network.');
				}else if(x.status==404){
				alert('Requested URL not found.');
				}else if(x.status==500){
				alert('Internal Server Error.');
				}else if(x.status==403){
				alert('La sessió ha caducat');
				}else if(e=='parsererror'){
				alert('Error.\nParsing JSON Request failed.');
				}else if(e=='timeout'){
				alert('Request Time out.');
				}else {
				alert('Unknow Error.\n'+x.responseText);
				}
				window.location.replace("/");

			},

		beforeSend: function(xhr, settings) {
	        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
	            xhr.setRequestHeader("X-CSRFToken", csrftoken);
	        }
	    }
		});


		$(".nts").change(function() {
			t = $(this);
			data = {
				'nota': t.val(),
				'alumne': t.attr('id_al'),
				'assignatura': {{ assignatura.id }},
				'tnota': t.attr('id_tn'),
				'inter': {{ inter.id }},
			};
			$.post("/notes/nnota", data);


		});

		$(".ncom").click(function() {
			var s = $(this).parent().serialize();
			$.post("/notes/noucomentari", s, function() { alert("Comentari actualitzat"); } );
			return false;

		});

		var last = null;
		$("#selectalumnes").change(function() {
			var id = $(this).val();
			if (last != null)
				last.toggle();

			last = $("[alid="+id+"]");
			last.toggle();
		})

		$("#selectalumnes").change();

		$("#butanterior").click(function() {
			var idselected = $("#selectalumnes").val();
			var elm = $("#selectalumnes").find("option[value='"+idselected+"']");
			var prev = elm.prev();
			if (prev.length == 0) return;
			prev.attr("selected", true);
			elm.attr("selected", false);
			$("#selectalumnes").change();
		});

		$("#butseguent").click(function() {
			var idselected = $("#selectalumnes").val();
			var elm = $("#selectalumnes").find("option[value='"+idselected+"']");
			var next = elm.next();
			if (next.length == 0) return;
			next.attr("selected", true);
			elm.attr("selected", false);
			$("#selectalumnes").change();
		});



});


</script>

<style type="text/css">

.hidden {
	display: none;
}

.divcomentari {
	margin-top: 20px;
	width: 100%;
}

</style>


{% endblock %}


{% block content %}


<h1> Grup: {{ grup }} </h1>
<h2> Assignatura: {{ assignatura.nom }} </h2>

<table> <tr>
	<td> Alumne: </td>
	<td> <select id="selectalumnes">
			{% for a in alumnes %}
			<option value="{{ a.id }}"> {{ a }} </option>
			{% endfor %}
		</select>
	</td>
	<td>
		<!-- <input type="submit" value="anterior" id="butanterior"> -->
	</td>
	<td>
		<input type="submit" value="següent" id="butseguent">
	</td>
</table>

<br><br>

{% for al in alumnes %}
<div alid="{{ al.id }}" class="hidden">

<table>
	<thead>
	<tr>
		{% for t in tipnotes %}
			<th>{{ t.nom }}</th>
		{% endfor %}
	</tr>
	</thead>

	<tbody>
	<tr>
			{% for t in al.notes %}
				<td>
				<select class="nts" id_al="{{al.id}}" id_tn="{{t.tipnota.id}}" title="{{t.tipnota.nom}}" {% if desactivat %} disabled="1" {% endif %} >
					<option value="-1"></option>
				{% for i in t.tipnota.grupNota.itemnota_set.all %}
					{% ifequal i.id t.nota.nota.id %}
						<option value="{{ i.id }}" selected="selected">{{ i.it }}</option>
					{% else %}
						<option value="{{ i.id }}">{{ i.it }}</option>
					{% endifequal %}

				{% endfor %}
				</select>
				</td>
			{% endfor %}
	</tr>
	</tbody>
</table>

<div class="divcomentari">

	Comentari:
	<form method="POST">
	<textarea name="comentari" rows="3" cols="80" {% if desactivat %} disabled="1" {% endif %} >{{ al.comm }}</textarea>
	<br>
	<input type="hidden" name="al" value="{{al.id}}">
	<input type="hidden" name="as" value="{{assignatura.id}}">
	<input type="hidden" name="inter" value="{{inter.id}}">
	<input type="submit" name="envia" value="Actualitza" class="ncom"  {% if desactivat %} disabled="1" {% endif %} >

	</form>

</div>

</div>
{% endfor %}

{% endblock %}
